<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Falak Arcade ‚Äî Islamic Astronomy Mini-Game</title>

  <style>
    :root{
      --bg:#070a14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);

      --good: rgba(16,185,129,.22);
      --goodb: rgba(16,185,129,.45);
      --warn: rgba(245,158,11,.20);
      --warnb: rgba(245,158,11,.45);
      --bad:  rgba(244,63,94,.18);
      --badb: rgba(244,63,94,.45);

      --shadow: 0 18px 55px rgba(0,0,0,.48);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);

      --r: 22px;
      --r2: 16px;
      --pad: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 700px at 12% -10%, rgba(99,102,241,.30), transparent 60%),
                  radial-gradient(900px 700px at 88% 0%, rgba(34,197,94,.22), transparent 58%),
                  radial-gradient(1200px 900px at 50% 120%, rgba(245,158,11,.18), transparent 58%),
                  var(--bg);
      overflow-x:hidden;
    }

    /* starfield canvas sits behind everything */
    #starfield{
      position:fixed; inset:0;
      z-index:-2;
    }
    /* subtle vignette */
    .vignette{
      position:fixed; inset:-40px;
      background: radial-gradient(circle at center, transparent 42%, rgba(0,0,0,.55) 100%);
      z-index:-1;
      pointer-events:none;
      filter: blur(0px);
    }

    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    @media (min-width:900px){ .wrap{padding:34px} }

    /* GAME HEADER */
    .topbar{
      display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:52px;height:52px;border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(99,102,241,.0), rgba(99,102,241,.35), rgba(34,197,94,.25), rgba(245,158,11,.22), rgba(99,102,241,.0));
      animation: spin 9s linear infinite;
      opacity:.35;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .logo span{position:relative; z-index:1; font-size:22px}

    .h1{font-size:22px;font-weight:780;letter-spacing:-.03em;line-height:1.05}
    .sub{font-size:13px;color:var(--muted);margin-top:4px;max-width:680px}

    .hud{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end
    }

    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      padding:5px 10px;border-radius:999px;
      font-size:12px;color:var(--text);
      background:rgba(255,255,255,.07);
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }
    .badge.good{background:var(--good);border-color:var(--goodb)}
    .badge.warn{background:var(--warn);border-color:var(--warnb)}
    .badge.bad {background:var(--bad); border-color:var(--badb)}

    .progress{
      width:180px;height:12px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.15);
      overflow:hidden;
      box-shadow: var(--shadow2);
      position:relative;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.92), rgba(255,255,255,.55));
      filter: drop-shadow(0 0 10px rgba(255,255,255,.15));
    }
    .xpmeta{font-size:12px;color:var(--muted)}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      border:1px solid rgba(255,255,255,.14);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:16px 16px 10px 16px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      background: rgba(0,0,0,.10);
    }
    .panelHead h2{margin:0;font-size:15px;font-weight:760;letter-spacing:-.02em}
    .panelHead p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .panelBody{padding:16px}

    /* tabs look more game-like */
    .tabs{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:900px){ .tabs{grid-template-columns:repeat(4,1fr)} }
    .tab{
      padding:11px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:13px;
      cursor:pointer;
      display:flex;gap:8px;align-items:center;justify-content:center;
      user-select:none;
      transition:.14s transform, .14s background, .14s color, .14s box-shadow;
      box-shadow: 0 6px 18px rgba(0,0,0,.20);
    }
    .tab:hover{
      transform:translateY(-2px);
      background:rgba(255,255,255,.09);
      color:var(--text);
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
    }
    .tab.active{
      background:rgba(255,255,255,.13);
      color:var(--text);
      border-color:rgba(255,255,255,.22);
      box-shadow: 0 14px 30px rgba(0,0,0,.33);
    }

    .grid{display:grid;gap:14px}
    @media(min-width:900px){ .grid-3{grid-template-columns:1fr 1fr 1fr} .grid-2{grid-template-columns:1fr 1fr} }
    .colspan2{grid-column:1/-1}
    @media(min-width:900px){ .colspan2{grid-column:2/4} }

    .card{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardHead{padding:14px 14px 10px 14px}
    .cardHead h3{margin:0;font-size:13px;font-weight:760;letter-spacing:-.02em}
    .cardHead p{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .cardBody{padding:14px}

    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.09);
      color:var(--text);
      border-radius:16px;
      padding:11px 12px;
      font-size:13px;
      cursor:pointer;
      transition:.14s transform, .14s background, .14s box-shadow;
      user-select:none;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .btn:hover{
      transform:translateY(-2px);
      background:rgba(255,255,255,.13);
      box-shadow: 0 16px 28px rgba(0,0,0,.30);
    }
    .btn:active{transform:translateY(0px) scale(.99)}
    .btn.secondary{background:rgba(0,0,0,.25)}
    .btn.full{width:100%}
    .btnrow{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .mini{font-size:12px;color:var(--muted2)}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .hr{height:1px;background:rgba(255,255,255,.14);margin:12px 0}

    .control{margin:10px 0 14px}
    .control .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .control label{font-size:13px;font-weight:720}
    input[type="range"]{width:100%}
    .rangehint{display:flex;justify-content:space-between;font-size:11px;color:var(--muted2);margin-top:4px}

    .toggle{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
    }
    .toggle .t1{font-size:13px;font-weight:760}
    .toggle .t2{font-size:12px;color:var(--muted)}
    .switch{
      width:48px;height:28px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      position:relative;cursor:pointer;flex:0 0 auto;
      transition:.14s background, .14s border-color;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .switch::after{
      content:"";position:absolute;top:3px;left:3px;
      width:20px;height:20px;border-radius:50%;
      background:rgba(255,255,255,.88);
      transition:.14s transform;
      box-shadow: 0 8px 12px rgba(0,0,0,.25);
    }
    .switch.on{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.45)}
    .switch.on::after{transform:translateX(20px)}

    .note{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:13px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(255,255,255,.50);
      margin-top:4px;flex:0 0 auto;
      box-shadow: 0 0 14px rgba(255,255,255,.12);
    }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .item .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .item .t{font-size:13px;font-weight:760}
    .item .s{font-size:12px;color:var(--muted);margin-top:6px}
    .stars{font-size:12px;color:rgba(255,255,255,.78)}

    .select, .text{
      width:100%;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:13px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }

    .quizopt{cursor:pointer;transition:.14s background, .14s transform}
    .quizopt:hover{background:rgba(255,255,255,.09);transform:translateY(-1px)}
    .quizopt.active{background:rgba(255,255,255,.13);border-color:rgba(255,255,255,.22)}

    .feedback{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.14);box-shadow:var(--shadow2)}
    .feedback.good{background:rgba(16,185,129,.14);border-color:rgba(16,185,129,.35)}
    .feedback.bad {background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}

    /* little ‚Äúgame‚Äù animations */
    .pop{animation: pop .22s ease-out}
    @keyframes pop{
      0%{transform:scale(.96)}
      100%{transform:scale(1)}
    }
    .shake{animation: shake .35s ease-in-out}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-5px)}
      50%{transform:translateX(5px)}
      75%{transform:translateX(-3px)}
      100%{transform:translateX(0)}
    }

    /* top-right small controls */
    .hudBtn{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.25);
      padding:7px 10px;border-radius:999px;
      font-size:12px;color:var(--text);
      cursor:pointer;
      user-select:none;
      box-shadow: var(--shadow2);
      transition:.14s transform,.14s background;
    }
    .hudBtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .hudBtn .tinySwitch{
      width:36px;height:20px;border-radius:999px;border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.09);
      position:relative;
    }
    .hudBtn .tinySwitch::after{
      content:"";position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;
      background:rgba(255,255,255,.85);
      transition:.14s transform;
    }
    .hudBtn.on .tinySwitch{background:rgba(16,185,129,.22);border-color:rgba(16,185,129,.45)}
    .hudBtn.on .tinySwitch::after{transform:translateX(16px)}

    /* confetti canvas (front layer) */
    #fx{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:50;
    }

    /* footer */
    .footer{padding:14px 16px}
  </style>
</head>

<body>
  <canvas id="starfield"></canvas>
  <div class="vignette"></div>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üåô</span></div>
        <div>
          <div class="h1">Falak Arcade</div>
          <div class="sub">Play & learn: hilal visibility intuition, Qibla bearings, high-latitude prayer time rules, and quiz challenges.</div>
        </div>
      </div>

      <div class="hud">
        <div class="hudBtn on" id="soundToggle" title="Toggle sound effects">
          üîä Sound
          <div class="tinySwitch" aria-hidden="true"></div>
        </div>

        <span class="badge" id="levelBadge">Level 1</span>
        <div class="progress" title="XP progress">
          <div class="bar" id="xpBar"></div>
        </div>
        <span class="xpmeta" id="xpMeta">0/120 XP</span>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div>
          <h2>Choose a mode</h2>
          <p>Educational simulation only ‚Äî use official authorities/timetables for real decisions.</p>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <span class="badge" id="dailySeed">Daily seed</span>
        </div>
      </div>

      <div class="panelBody">
        <div class="tabs">
          <div class="tab active" data-tab="hilal">üî≠ Hilal Hunt</div>
          <div class="tab" data-tab="qibla">üß≠ Qibla Quest</div>
          <div class="tab" data-tab="prayer">‚òÄÔ∏è Prayer Planner</div>
          <div class="tab" data-tab="quiz">üìò Quick Quiz</div>
        </div>

        <div style="height:14px"></div>

        <!-- HILAL -->
        <section id="panel-hilal">
          <div class="grid grid-3">
            <div class="card">
              <div class="cardHead">
                <h3>Setup</h3>
                <p>Adjust parameters and decide: Seen / Not seen.</p>
              </div>
              <div class="cardBody">
                <button class="btn secondary full" id="btnRandomHilal">‚ö° Random case</button>
                <div style="height:12px"></div>

                <div class="control">
                  <div class="top">
                    <label for="altRange">Moon altitude at sunset (¬∞)</label>
                    <span class="badge" id="altVal">2.2</span>
                  </div>
                  <input id="altRange" type="range" min="-0.5" max="12" step="0.1" value="2.2">
                  <div class="rangehint"><span>-0.5</span><span>12</span></div>
                  <div class="mini">Higher altitude generally improves chances.</div>
                </div>

                <div class="control">
                  <div class="top">
                    <label for="elongRange">Elongation (¬∞)</label>
                    <span class="badge" id="elongVal">7.0</span>
                  </div>
                  <input id="elongRange" type="range" min="0" max="18" step="0.1" value="7.0">
                  <div class="rangehint"><span>0</span><span>18</span></div>
                  <div class="mini">Wider separation from the Sun helps visibility.</div>
                </div>

                <div class="control">
                  <div class="top">
                    <label for="ageRange">Moon age after conjunction (hours)</label>
                    <span class="badge" id="ageVal">16</span>
                  </div>
                  <input id="ageRange" type="range" min="0" max="30" step="1" value="16">
                  <div class="rangehint"><span>0</span><span>30</span></div>
                  <div class="mini">Older crescents tend to be easier (simplified).</div>
                </div>

                <div class="control">
                  <div class="top">
                    <label for="widthRange">Crescent width (arcmin)</label>
                    <span class="badge" id="widthVal">0.12</span>
                  </div>
                  <input id="widthRange" type="range" min="0" max="0.6" step="0.01" value="0.12">
                  <div class="rangehint"><span>0</span><span>0.6</span></div>
                  <div class="mini">Thicker crescents are usually brighter.</div>
                </div>

                <div class="toggle">
                  <div>
                    <div class="t1">Haze</div>
                    <div class="t2">Light scattering reduces contrast.</div>
                  </div>
                  <div class="switch" id="hazeSwitch" role="switch" aria-checked="false" tabindex="0"></div>
                </div>

                <div style="height:12px"></div>

                <div class="toggle">
                  <div>
                    <div class="t1">Clouds near horizon</div>
                    <div class="t2">May block the crescent even with good geometry.</div>
                  </div>
                  <div class="switch" id="cloudSwitch" role="switch" aria-checked="false" tabindex="0"></div>
                </div>

                <div style="height:12px"></div>

                <div class="btnrow">
                  <button class="btn full" id="btnSeen">‚úÖ Seen</button>
                  <button class="btn secondary full" id="btnNotSeen">‚ùå Not seen</button>
                </div>
              </div>
            </div>

            <div class="card colspan2">
              <div class="cardHead">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                  <h3>Analysis</h3>
                  <span class="badge warn" id="hilalVerdictBadge">Uncertain</span>
                </div>
                <p>Educational visibility score: <b><span id="scorePct">0</span></b> / 100</p>
              </div>
              <div class="cardBody">
                <div class="note">
                  <div class="dot"></div>
                  <div>
                    <div style="font-weight:760;color:var(--text);margin-bottom:6px">How to think about it</div>
                    <ul style="margin:0;padding-left:18px;line-height:1.55">
                      <li>Altitude + elongation set the geometry near sunset.</li>
                      <li>Age + width relate to brightness (simplified).</li>
                      <li>Haze/clouds can dominate real outcomes even with good geometry.</li>
                    </ul>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div class="grid grid-2">
                  <div class="card">
                    <div class="cardHead">
                      <h3>Your recent attempts</h3>
                      <p>Patterns ‚Üí XP. Try extreme cases too.</p>
                    </div>
                    <div class="cardBody">
                      <div class="list" id="hilalLog"></div>
                      <div class="mini" id="hilalEmpty">No attempts yet. Try a case and decide.</div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="cardHead">
                      <h3>Mini quests</h3>
                      <p>Small missions to make it feel like a game.</p>
                    </div>
                    <div class="cardBody">
                      <div class="list">
                        <div class="note"><div class="dot"></div><div>Create a ‚ÄúLikely visible‚Äù case without haze/clouds.</div></div>
                        <div class="note"><div class="dot"></div><div>Turn on haze and observe how the verdict changes.</div></div>
                        <div class="note"><div class="dot"></div><div>Keep geometry the same, increase width‚Äîwhat happens?</div></div>
                        <div class="note"><div class="dot"></div><div>Find a case where verdict is ‚ÄúUncertain‚Äù.</div></div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <!-- QIBLA -->
        <section id="panel-qibla" style="display:none">
          <div class="grid grid-3">
            <div class="card">
              <div class="cardHead">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                  <h3>Target city</h3>
                  <button class="btn secondary" id="btnNextCity">üîÅ Change</button>
                </div>
                <p>Try to land within 6¬∞ for ‚òÖ‚òÖ‚òÖ.</p>
              </div>
              <div class="cardBody">
                <div class="item pop">
                  <div class="t" id="qCity">Kuala Lumpur</div>
                  <div class="s" id="qTip">Tip...</div>
                </div>

                <div style="height:12px"></div>

                <div class="control">
                  <div class="top">
                    <label for="bearingRange">Your bearing</label>
                    <span class="badge" id="bearingVal">0¬∞</span>
                  </div>
                  <input id="bearingRange" type="range" min="0" max="359" step="1" value="0">
                  <div class="mini">0¬∞=North, 90¬∞=East, 180¬∞=South, 270¬∞=West</div>
                </div>

                <button class="btn full" id="btnSubmitQibla">üß≠ Submit</button>
              </div>
            </div>

            <div class="card colspan2">
              <div class="cardHead">
                <h3>Results & learning</h3>
                <p>More accuracy ‚Üí more stars ‚Üí more XP.</p>
              </div>
              <div class="cardBody">
                <div class="note">
                  <div class="dot"></div>
                  <div><b style="color:var(--text)">Real-world note:</b> Accurate Qibla uses great-circle direction (geodesy). This is simplified for intuition.</div>
                </div>

                <div style="height:12px"></div>

                <div class="grid grid-2">
                  <div class="card">
                    <div class="cardHead">
                      <h3>Recent attempts</h3>
                      <p>Keep improving your ‚òÖ score.</p>
                    </div>
                    <div class="cardBody">
                      <div class="list" id="qiblaLog"></div>
                      <div class="mini" id="qiblaEmpty">No attempts yet.</div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="cardHead">
                      <h3>Challenge goals</h3>
                      <p>Different approaches to master it.</p>
                    </div>
                    <div class="cardBody">
                      <div class="list">
                        <div class="note"><div class="dot"></div><div>Get ‚òÖ‚òÖ‚òÖ twice in a row.</div></div>
                        <div class="note"><div class="dot"></div><div>Compare UK vs Malaysia directions ‚Äî explain why.</div></div>
                        <div class="note"><div class="dot"></div><div>Explain ‚Äúgreat-circle‚Äù in one sentence.</div></div>
                        <div class="note"><div class="dot"></div><div>Relate compass bearings to map rotation.</div></div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <!-- PRAYER -->
        <section id="panel-prayer" style="display:none">
          <div class="grid grid-3">
            <div class="card">
              <div class="cardHead">
                <h3>Scenario</h3>
                <p>Pick a case and choose a method.</p>
              </div>
              <div class="cardBody">
                <div class="mini" style="margin-bottom:8px">Choose scenario</div>
                <div class="list" id="scenarioList"></div>

                <div class="hr"></div>

                <div class="mini" style="margin-bottom:8px">Choose method</div>
                <select class="select" id="methodSelect"></select>
                <div class="mini" id="methodDetail" style="margin-top:8px"></div>

                <div style="height:12px"></div>
                <button class="btn full" id="btnSubmitPrayer">‚è±Ô∏è Submit method</button>
              </div>
            </div>

            <div class="card colspan2">
              <div class="cardHead">
                <h3>Feedback</h3>
                <p>Different councils can apply different rules ‚Äî this is a learning game.</p>
              </div>
              <div class="cardBody">

                <div class="note" id="scenarioHintBox">
                  <div class="dot"></div>
                  <div>
                    <div style="font-weight:760;color:var(--text);margin-bottom:6px">Hint</div>
                    <div id="scenarioHint">...</div>
                  </div>
                </div>

                <div style="height:12px"></div>

                <div class="grid grid-2">
                  <div class="card">
                    <div class="cardHead">
                      <h3>Acceptable (in this game)</h3>
                      <p>Use local authority for real practice.</p>
                    </div>
                    <div class="cardBody">
                      <div style="display:flex;flex-wrap:wrap;gap:8px" id="acceptableBadges"></div>
                      <div class="mini" style="margin-top:10px">Real implementations depend on fiqh positions and authority decisions.</div>
                    </div>
                  </div>

                  <div class="card">
                    <div class="cardHead">
                      <h3>Your recent picks</h3>
                      <p>Track what works per scenario.</p>
                    </div>
                    <div class="cardBody">
                      <div class="list" id="prayerLog"></div>
                      <div class="mini" id="prayerEmpty">No submissions yet.</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <!-- QUIZ -->
        <section id="panel-quiz" style="display:none">
          <div class="grid grid-3">
            <div class="card">
              <div class="cardHead">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                  <h3>Question</h3>
                  <span class="badge" id="quizTag">Hilal</span>
                </div>
                <p>Streak: <b><span id="quizStreak">0</span></b></p>
              </div>
              <div class="cardBody">
                <div class="item" id="quizQWrap">
                  <div class="t" id="quizQ">...</div>
                </div>

                <div style="height:12px"></div>

                <div class="list" id="quizOptions"></div>

                <div style="height:12px"></div>

                <div class="btnrow">
                  <button class="btn full" id="btnQuizSubmit">Submit</button>
                  <button class="btn secondary full" id="btnQuizNext">Next</button>
                </div>

                <div style="height:12px"></div>
                <div id="quizFeedback"></div>
              </div>
            </div>

            <div class="card colspan2">
              <div class="cardHead">
                <h3>Build your own set</h3>
                <p>Add questions for your class, workshop, or journal club.</p>
              </div>
              <div class="cardBody">
                <div class="grid grid-2" style="margin-bottom:10px">
                  <div>
                    <div class="mini" style="margin-bottom:6px">Question</div>
                    <input class="text" id="qbQ" placeholder="Write a question about falak..." />
                  </div>
                  <div>
                    <div class="mini" style="margin-bottom:6px">Tag</div>
                    <input class="text" id="qbTag" placeholder="Hilal / Qibla / Prayer Times" value="Custom"/>
                  </div>
                </div>

                <div class="grid grid-2">
                  <input class="text" id="qbA" placeholder="Option A" />
                  <input class="text" id="qbB" placeholder="Option B" />
                  <input class="text" id="qbC" placeholder="Option C" />
                  <input class="text" id="qbD" placeholder="Option D" />
                </div>

                <div style="height:12px"></div>

                <div class="grid grid-2">
                  <div>
                    <div class="mini" style="margin-bottom:6px">Correct answer</div>
                    <select class="select" id="qbAns">
                      <option value="0">A</option>
                      <option value="1" selected>B</option>
                      <option value="2">C</option>
                      <option value="3">D</option>
                    </select>
                  </div>
                  <div>
                    <div class="mini" style="margin-bottom:6px">Explanation (optional)</div>
                    <input class="text" id="qbWhy" placeholder="Why is that the correct answer?" />
                  </div>
                </div>

                <div style="height:12px"></div>
                <button class="btn" id="btnAddQuestion">‚ûï Add question (+10 XP)</button>

                <div style="height:12px"></div>
                <div class="note">
                  <div class="dot"></div>
                  <div>Tip: tailor questions to rukyah, fiqh, image processing, light pollution, or your HORTOH workflow.</div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

    <div style="height:14px"></div>

    <div class="panel">
      <div class="footer">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-size:13px;font-weight:760">Your progress</div>
            <div class="mini muted">Total XP: <span id="totalXp">0</span> ‚Ä¢ Level <span id="totalLevel">1</span></div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="badge">Hilal</span>
            <span class="badge">Qibla</span>
            <span class="badge">Prayer Times</span>
            <span class="badge">Quiz</span>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===========================
   Falak Arcade ‚Äî Vanilla JS
   + game feel + sound effects
   =========================== */

// ---------- Helpers ----------
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const round1 = (n)=>Math.round(n*10)/10;
const round2 = (n)=>Math.round(n*100)/100;

function todaySeed(){
  const d=new Date();
  return (d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate())>>>0;
}
function seededRng(seed){
  let s = seed>>>0;
  return ()=>{ s=(1664525*s + 1013904223)>>>0; return s/4294967296; };
}
const SEED = todaySeed();
const rng = seededRng(SEED);
document.getElementById("dailySeed").textContent = `Daily seed: ${SEED}`;

// ---------- Sound (no external files) ----------
let soundOn = true;
let audioCtx = null;

function ensureAudio(){
  if(!soundOn) return null;
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function playTone({freq=440, type="sine", duration=0.08, gain=0.06, ramp=0.012}){
  const ctx = ensureAudio();
  if(!ctx) return;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = type;
  o.frequency.value = freq;

  const t = ctx.currentTime;
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(gain, t + ramp);
  g.gain.exponentialRampToValueAtTime(0.0001, t + duration);

  o.connect(g);
  g.connect(ctx.destination);

  o.start(t);
  o.stop(t + duration + 0.02);
}

function sfxClick(){ playTone({freq:520, type:"triangle", duration:0.06, gain:0.05}); }
function sfxToggle(){ playTone({freq:350, type:"square", duration:0.05, gain:0.035}); }
function sfxSuccess(){
  playTone({freq:523.25, type:"sine", duration:0.08, gain:0.06});
  setTimeout(()=>playTone({freq:659.25, type:"sine", duration:0.10, gain:0.06}), 70);
}
function sfxFail(){
  playTone({freq:220, type:"sawtooth", duration:0.10, gain:0.05});
  setTimeout(()=>playTone({freq:185, type:"sawtooth", duration:0.10, gain:0.05}), 70);
}
function sfxLevelUp(){
  playTone({freq:440, type:"sine", duration:0.10, gain:0.06});
  setTimeout(()=>playTone({freq:660, type:"sine", duration:0.12, gain:0.06}), 110);
  setTimeout(()=>playTone({freq:880, type:"sine", duration:0.14, gain:0.06}), 240);
}

// sound toggle
const soundToggle = document.getElementById("soundToggle");
soundToggle.addEventListener("click", ()=>{
  soundOn = !soundOn;
  soundToggle.classList.toggle("on", soundOn);
  soundToggle.innerHTML = `${soundOn ? "üîä" : "üîá"} Sound <div class="tinySwitch" aria-hidden="true"></div>`;
  sfxToggle();
});

// Make first user interaction resume audio on some browsers:
document.addEventListener("pointerdown", ()=>ensureAudio(), {once:true});

// ---------- FX (confetti / sparkle burst) ----------
const fxCanvas = document.getElementById("fx");
const fxCtx = fxCanvas.getContext("2d");
let fxW=0, fxH=0;
function resizeFx(){ fxW=fxCanvas.width=window.innerWidth; fxH=fxCanvas.height=window.innerHeight; }
window.addEventListener("resize", resizeFx);
resizeFx();

const particles = [];
function burst(x,y, kind="good"){
  const n = 26;
  for(let i=0;i<n;i++){
    const a = Math.random()*Math.PI*2;
    const sp = 1.6 + Math.random()*4.0;
    particles.push({
      x, y,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp - (1.5 + Math.random()*1.8),
      life: 55 + Math.random()*25,
      size: 2 + Math.random()*3,
      kind,
      rot: Math.random()*Math.PI*2,
      vr: (Math.random()-0.5)*0.25
    });
  }
}
function fxTick(){
  fxCtx.clearRect(0,0,fxW,fxH);
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.life -= 1;
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.09; // gravity
    p.vx *= 0.985;
    p.vy *= 0.985;
    p.rot += p.vr;

    const alpha = Math.max(0, Math.min(1, p.life/70));
    fxCtx.save();
    fxCtx.translate(p.x, p.y);
    fxCtx.rotate(p.rot);
    fxCtx.globalAlpha = alpha;

    if(p.kind==="good"){
      fxCtx.fillStyle = "rgba(180,255,225,0.95)";
    } else if(p.kind==="warn"){
      fxCtx.fillStyle = "rgba(255,220,150,0.95)";
    } else {
      fxCtx.fillStyle = "rgba(255,170,190,0.95)";
    }
    fxCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
    fxCtx.restore();

    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(fxTick);
}
fxTick();

// helper to burst at element center
function burstAtEl(el, kind){
  const r = el.getBoundingClientRect();
  burst(r.left + r.width/2, r.top + r.height/2, kind);
}

// ---------- Starfield (background) ----------
const starCanvas = document.getElementById("starfield");
const sctx = starCanvas.getContext("2d");
let sw=0, sh=0;
let stars = [];

function resizeStars(){
  sw = starCanvas.width = window.innerWidth;
  sh = starCanvas.height = window.innerHeight;
  // regenerate stars
  const count = Math.floor((sw*sh)/22000);
  stars = [];
  for(let i=0;i<count;i++){
    stars.push({
      x: Math.random()*sw,
      y: Math.random()*sh,
      z: 0.2 + Math.random()*1.6,
      a: 0.15 + Math.random()*0.55,
      tw: Math.random()*Math.PI*2
    });
  }
}
window.addEventListener("resize", resizeStars);
resizeStars();

function starTick(){
  sctx.clearRect(0,0,sw,sh);
  for(const st of stars){
    st.tw += 0.015*(st.z);
    const tw = (Math.sin(st.tw)+1)/2;
    const alpha = st.a*(0.55 + tw*0.45);

    sctx.globalAlpha = alpha;
    sctx.fillStyle = "white";
    const r = 0.6 + st.z*0.6;
    sctx.beginPath();
    sctx.arc(st.x, st.y, r, 0, Math.PI*2);
    sctx.fill();

    // slow drift
    st.y += 0.05*st.z;
    if(st.y > sh+10){ st.y = -10; st.x = Math.random()*sw; }
  }
  requestAnimationFrame(starTick);
}
starTick();

// ---------- Educational Model ----------
function hilalScore({altDeg, elongDeg, ageHours, widthArcMin, haze, clouds}){
  const alt = clamp(altDeg, -1, 15);
  const el  = clamp(elongDeg, 0, 20);
  const age = clamp(ageHours, 0, 30);
  const w   = clamp(widthArcMin, 0, 1);

  const base =
    0.35*(alt/10) +
    0.35*(el/15) +
    0.20*(age/24) +
    0.10*(w/0.4);

  const weatherPenalty = (haze?0.14:0) + (clouds?0.22:0);
  const score = clamp(base - weatherPenalty, 0, 1);

  const likely = score >= 0.62;
  const maybe  = score >= 0.45 && score < 0.62;
  return {score, likely, maybe};
}
function verdictText({likely, maybe}){
  if(likely) return {label:"Likely visible", tone:"good"};
  if(maybe)  return {label:"Uncertain", tone:"warn"};
  return {label:"Unlikely", tone:"bad"};
}
function setVerdictBadge(el, verdict){
  el.textContent = verdict.label;
  el.classList.remove("good","warn","bad");
  el.classList.add(verdict.tone);
}

function degDiff(a,b){
  const d = Math.abs(((a-b+180)%360)-180);
  return d;
}
function safeId(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

// ---------- Game State ----------
let xp = 0;
let lastLevel = 1;

// Hilal state
let hilal = {
  altDeg: 2.2, elongDeg: 7.0, ageHours: 16, widthArcMin: 0.12,
  haze: false, clouds: false, log: []
};

// Qibla state
const QIBLA_LEVELS = [
  { city: "Kuala Lumpur", bearing: 292, tip: "From SE Asia, Qibla is roughly WNW." },
  { city: "London", bearing: 118, tip: "From UK, Qibla is roughly ESE." },
  { city: "Tokyo", bearing: 263, tip: "From Japan, Qibla is roughly W." },
  { city: "Cape Town", bearing: 25,  tip: "From South Africa, Qibla is roughly NNE." },
  { city: "New York", bearing: 58,  tip: "From USA East Coast, Qibla is roughly NE." }
];
let qibla = { idx: Math.floor(rng()*QIBLA_LEVELS.length), guess: 0, log: [] };

// Prayer planner
const PRAYER_SCENARIOS = [
  { id:"malaysia", title:"Equatorial-ish (e.g., Malaysia)", desc:"Normal night; clear separation of twilight and night.", lat:5,
    hint:"Standard angle-based methods usually work fine.", correct:["Standard (angles)","Local authority timetable"] },
  { id:"uk_summer", title:"High latitude summer (e.g., UK)", desc:"Very late/short night; twilight may persist.", lat:52,
    hint:"Often needs adjusted methods (nearest latitude/day, 1/7 night, middle of night) per authority guidance.",
    correct:["Middle of the night","1/7 night","Nearest latitude","Nearest day"] },
  { id:"arctic", title:"Polar region (midnight sun)", desc:"Sun does not set for weeks.", lat:69,
    hint:"Fixed schedules and authority guidance become essential.", correct:["Local authority timetable","Nearest latitude"] }
];
const PRAYER_METHODS = [
  {name:"Standard (angles)", detail:"Uses sun angles for Fajr/Isha (works where twilight behaves normally)."},
  {name:"Middle of the night", detail:"Splits night into halves; sets times around midpoint (used in some guidance)."},
  {name:"1/7 night", detail:"Divides night into 7 parts; allocates twilight portion (seen in some fiqh discussions)."},
  {name:"Nearest latitude", detail:"Adopts times from a latitude where twilight is normal (e.g., 48¬∞)."},
  {name:"Nearest day", detail:"Uses nearest day when angles become valid again."},
  {name:"Local authority timetable", detail:"Follow official timetable/masjid guidance for your region."}
];
let prayer = { scenarioId: PRAYER_SCENARIOS[0].id, method: PRAYER_METHODS[0].name, log: [] };

// Quiz
let QUIZ_BANK = [
  { q:"In Islamic astronomy (falak), what does ‚Äòhilal‚Äô usually refer to?",
    options:["A meteor shower","The first visible crescent after conjunction","A solar eclipse","The full moon"],
    answer:1, why:"Hilal commonly means the first visible crescent Moon marking the start of a lunar month.", tag:"Hilal" },
  { q:"Why can prayer times be challenging in high latitudes during summer?",
    options:["Because the Moon is always below the horizon","Because twilight can persist and the Sun may not reach standard angles","Because the Kaaba changes location","Because Earth stops rotating"],
    answer:1, why:"At high latitudes, twilight may not end (or becomes very short), making standard definitions difficult.", tag:"Prayer Times" },
  { q:"Qibla is the direction Muslims face during prayer toward:",
    options:["Al-Aqsa Mosque","The Kaaba in Makkah","The North Star","The Sun"],
    answer:1, why:"Qibla direction is toward the Kaaba in Makkah.", tag:"Qibla" },
  { q:"Which tool is most directly used for observing the crescent in traditional rukyah?",
    options:["Thermometer","Telescope/Binoculars","Seismograph","Barometer"],
    answer:1, why:"Optical aids like binoculars or telescopes can help observe the crescent (subject to local practice).", tag:"Observation" },
  { q:"In general, more haze and clouds at the western horizon will:",
    options:["Increase hilal visibility","Have no effect","Reduce visibility","Move the Moon"],
    answer:2, why:"Atmospheric conditions strongly impact optical visibility.", tag:"Atmosphere" }
];
let quiz = { idx: Math.floor(rng()*QUIZ_BANK.length), pick: null, streak: 0, feedback: null };

// ---------- XP / Level ----------
function levelFromXp(x){ return Math.floor(x/120)+1; }
function xpInLevel(x){ return x%120; }

function addXp(delta, kind="good", burstEl=null){
  const beforeLevel = levelFromXp(xp);
  xp += delta;
  const afterLevel = levelFromXp(xp);

  renderXp();

  if(burstEl){
    burstAtEl(burstEl, kind);
  }else{
    burst(window.innerWidth*0.5, 120, kind);
  }

  if(afterLevel > beforeLevel){
    sfxLevelUp();
    burst(window.innerWidth*0.5, 100, "good");
    document.getElementById("levelBadge").classList.add("pop");
    setTimeout(()=>document.getElementById("levelBadge").classList.remove("pop"), 240);
  }
}

function renderXp(){
  const lvl = levelFromXp(xp);
  const inLvl = xpInLevel(xp);
  document.getElementById("levelBadge").textContent = `Level ${lvl}`;
  document.getElementById("xpMeta").textContent = `${inLvl}/120 XP`;
  document.getElementById("xpBar").style.width = `${(inLvl/120)*100}%`;

  document.getElementById("totalXp").textContent = xp;
  document.getElementById("totalLevel").textContent = lvl;
}

// ---------- Tabs ----------
const tabs = document.querySelectorAll(".tab");
const panels = {
  hilal: document.getElementById("panel-hilal"),
  qibla: document.getElementById("panel-qibla"),
  prayer: document.getElementById("panel-prayer"),
  quiz: document.getElementById("panel-quiz")
};

tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    sfxClick();
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const k=t.dataset.tab;
    Object.keys(panels).forEach(p=>panels[p].style.display = (p===k) ? "" : "none");
  });
});

// ---------- Hilal UI ----------
const altRange = document.getElementById("altRange");
const elongRange = document.getElementById("elongRange");
const ageRange = document.getElementById("ageRange");
const widthRange = document.getElementById("widthRange");
const hazeSwitch = document.getElementById("hazeSwitch");
const cloudSwitch = document.getElementById("cloudSwitch");

function syncHilalFromControls(){
  hilal.altDeg = parseFloat(altRange.value);
  hilal.elongDeg = parseFloat(elongRange.value);
  hilal.ageHours = parseInt(ageRange.value,10);
  hilal.widthArcMin = parseFloat(widthRange.value);
  renderHilal();
}
function setSwitch(el, on){
  el.classList.toggle("on", !!on);
  el.setAttribute("aria-checked", on ? "true":"false");
}
function toggleSwitch(el, key){
  hilal[key] = !hilal[key];
  setSwitch(el, hilal[key]);
  renderHilal();
  sfxToggle();
}
function renderHilal(){
  document.getElementById("altVal").textContent = hilal.altDeg.toFixed(1);
  document.getElementById("elongVal").textContent = hilal.elongDeg.toFixed(1);
  document.getElementById("ageVal").textContent = String(hilal.ageHours);
  document.getElementById("widthVal").textContent = hilal.widthArcMin.toFixed(2);

  setSwitch(hazeSwitch, hilal.haze);
  setSwitch(cloudSwitch, hilal.clouds);

  const hs = hilalScore(hilal);
  const v = verdictText(hs);
  setVerdictBadge(document.getElementById("hilalVerdictBadge"), v);
  document.getElementById("scorePct").textContent = Math.round(hs.score*100);

  const logWrap = document.getElementById("hilalLog");
  logWrap.innerHTML = "";
  document.getElementById("hilalEmpty").style.display = hilal.log.length ? "none" : "";
  hilal.log.forEach(r=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="top">
        <div class="t">${r.verdict}</div>
        <span class="badge">+${r.delta} XP</span>
      </div>
      <div class="s">Alt ${r.altDeg}¬∞, El ${r.elongDeg}¬∞, Age ${r.ageHours}h, Width ${r.widthArcMin}‚Ä≤
        ${r.haze ? " ‚Ä¢ haze":""}${r.clouds ? " ‚Ä¢ clouds":""}
      </div>
      <div class="mini muted2" style="margin-top:6px">You chose: ${r.decision === "seen" ? "Seen" : "Not seen"}</div>
    `;
    logWrap.appendChild(div);
  });
}

[altRange, elongRange, ageRange, widthRange].forEach(el=>{
  el.addEventListener("input", ()=>{ syncHilalFromControls(); });
});

hazeSwitch.addEventListener("click", ()=>toggleSwitch(hazeSwitch,"haze"));
cloudSwitch.addEventListener("click", ()=>toggleSwitch(cloudSwitch,"clouds"));
hazeSwitch.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(hazeSwitch,"haze"); } });
cloudSwitch.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleSwitch(cloudSwitch,"clouds"); } });

document.getElementById("btnRandomHilal").addEventListener("click", (e)=>{
  sfxClick();
  hilal.altDeg = round1(0.5 + rng()*6.0);
  hilal.elongDeg = round1(4.0 + rng()*8.0);
  hilal.ageHours = Math.round(8 + rng()*18);
  hilal.widthArcMin = round2(0.04 + rng()*0.26);
  hilal.haze = rng() < 0.35;
  hilal.clouds = rng() < 0.25;

  altRange.value = hilal.altDeg;
  elongRange.value = hilal.elongDeg;
  ageRange.value = hilal.ageHours;
  widthRange.value = hilal.widthArcMin;

  renderHilal();
  burstAtEl(e.currentTarget, "warn");
});

function submitHilalDecision(decision, btnEl){
  const hs = hilalScore(hilal);
  const v = verdictText(hs);

  let delta, good;
  if(hs.maybe){
    delta = 8; // learning zone
    good = "warn";
  } else {
    const correct = hs.likely ? (decision==="seen") : (decision==="not");
    delta = correct ? 20 : 5;
    good = correct ? "good" : "bad";
  }

  addXp(delta, good, btnEl);

  if(good==="good") sfxSuccess();
  else if(good==="bad") { sfxFail(); btnEl.classList.add("shake"); setTimeout(()=>btnEl.classList.remove("shake"), 380); }
  else sfxClick();

  hilal.log.unshift({
    id: safeId(),
    altDeg: hilal.altDeg, elongDeg: hilal.elongDeg, ageHours: hilal.ageHours,
    widthArcMin: hilal.widthArcMin, haze: hilal.haze, clouds: hilal.clouds,
    decision, verdict: v.label, score: hs.score, delta
  });
  hilal.log = hilal.log.slice(0,8);
  renderHilal();
}

document.getElementById("btnSeen").addEventListener("click", (e)=>submitHilalDecision("seen", e.currentTarget));
document.getElementById("btnNotSeen").addEventListener("click", (e)=>submitHilalDecision("not", e.currentTarget));

// ---------- Qibla UI ----------
function currentQibla(){ return QIBLA_LEVELS[qibla.idx]; }
const bearingRange = document.getElementById("bearingRange");

function renderQibla(){
  const lvl = currentQibla();
  document.getElementById("qCity").textContent = lvl.city;
  document.getElementById("qTip").textContent = "Tip: " + lvl.tip;
  document.getElementById("bearingVal").textContent = qibla.guess + "¬∞";

  const logWrap = document.getElementById("qiblaLog");
  logWrap.innerHTML = "";
  document.getElementById("qiblaEmpty").style.display = qibla.log.length ? "none" : "";
  qibla.log.forEach(r=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="top">
        <div class="t">${r.city}</div>
        <span class="badge">+${r.delta} XP</span>
      </div>
      <div class="s">Target ${r.target}¬∞ ‚Ä¢ You ${r.guess}¬∞ ‚Ä¢ Œî ${Math.round(r.diff)}¬∞</div>
      <div class="mini muted2" style="margin-top:6px">Stars: <span class="stars">${"‚òÖ".repeat(r.stars)}${"‚òÜ".repeat(3-r.stars)}</span></div>
    `;
    logWrap.appendChild(div);
  });
}

bearingRange.addEventListener("input", ()=>{
  qibla.guess = parseInt(bearingRange.value,10);
  renderQibla();
});

document.getElementById("btnNextCity").addEventListener("click", (e)=>{
  sfxClick();
  qibla.idx = (qibla.idx + 1) % QIBLA_LEVELS.length;
  qibla.guess = 0;
  bearingRange.value = 0;
  renderQibla();
  burstAtEl(e.currentTarget, "warn");
});

document.getElementById("btnSubmitQibla").addEventListener("click", (e)=>{
  const lvl = currentQibla();
  const diff = degDiff(qibla.guess, lvl.bearing);
  const stars = diff <= 6 ? 3 : diff <= 15 ? 2 : diff <= 30 ? 1 : 0;
  const delta = 6 + stars*10;

  const kind = stars>=2 ? "good" : stars===1 ? "warn" : "bad";
  addXp(delta, kind, e.currentTarget);

  if(stars>=2) sfxSuccess(); else if(stars===0) sfxFail(); else sfxClick();

  qibla.log.unshift({ id:safeId(), city:lvl.city, target:lvl.bearing, guess:qibla.guess, diff, stars, delta });
  qibla.log = qibla.log.slice(0,8);

  // next
  qibla.idx = (qibla.idx + 1) % QIBLA_LEVELS.length;
  qibla.guess = 0;
  bearingRange.value = 0;
  renderQibla();
});

// ---------- Prayer Planner UI ----------
const scenarioList = document.getElementById("scenarioList");
const methodSelect = document.getElementById("methodSelect");
const methodDetail = document.getElementById("methodDetail");

function renderScenarioList(){
  scenarioList.innerHTML = "";
  PRAYER_SCENARIOS.forEach(s=>{
    const btn=document.createElement("button");
    btn.type="button";
    btn.className="item quizopt";
    if(s.id===prayer.scenarioId) btn.classList.add("active");
    btn.innerHTML = `
      <div class="top">
        <div class="t">${s.title}</div>
        <span class="badge">~${s.lat}¬∞</span>
      </div>
      <div class="s">${s.desc}</div>
    `;
    btn.addEventListener("click", ()=>{
      sfxClick();
      prayer.scenarioId = s.id;
      renderPrayer();
    });
    scenarioList.appendChild(btn);
  });
}
function renderMethodSelect(){
  methodSelect.innerHTML = "";
  PRAYER_METHODS.forEach(m=>{
    const opt=document.createElement("option");
    opt.value=m.name; opt.textContent=m.name;
    methodSelect.appendChild(opt);
  });
  methodSelect.value = prayer.method;
}
function renderPrayer(){
  renderScenarioList();
  const sc = PRAYER_SCENARIOS.find(x=>x.id===prayer.scenarioId) || PRAYER_SCENARIOS[0];
  document.getElementById("scenarioHint").textContent = sc.hint;

  // acceptable badges
  const wrap=document.getElementById("acceptableBadges");
  wrap.innerHTML="";
  sc.correct.forEach(c=>{
    const b=document.createElement("span");
    b.className="badge";
    b.textContent=c;
    wrap.appendChild(b);
  });

  const md = PRAYER_METHODS.find(m=>m.name===prayer.method);
  methodDetail.textContent = md ? md.detail : "";

  // log
  const logWrap = document.getElementById("prayerLog");
  logWrap.innerHTML="";
  document.getElementById("prayerEmpty").style.display = prayer.log.length ? "none" : "";
  prayer.log.forEach(r=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="top">
        <div class="t">${r.scenario}</div>
        <span class="badge">+${r.delta} XP</span>
      </div>
      <div class="s">Method: ${r.method}</div>
      <div class="mini" style="margin-top:6px;color:${r.ok ? "rgba(16,185,129,.95)" : "rgba(245,158,11,.95)"}">
        ${r.ok ? "Reasonable for this scenario" : "Less suitable here (try another rule)"}
      </div>
    `;
    logWrap.appendChild(div);
  });
}
methodSelect.addEventListener("change", ()=>{
  sfxClick();
  prayer.method = methodSelect.value;
  renderPrayer();
});
document.getElementById("btnSubmitPrayer").addEventListener("click", (e)=>{
  const sc = PRAYER_SCENARIOS.find(x=>x.id===prayer.scenarioId) || PRAYER_SCENARIOS[0];
  const ok = sc.correct.includes(prayer.method);
  const delta = ok ? 20 : 7;
  addXp(delta, ok ? "good" : "warn", e.currentTarget);
  ok ? sfxSuccess() : sfxClick();

  prayer.log.unshift({ id:safeId(), scenario: sc.title, method: prayer.method, ok, delta });
  prayer.log = prayer.log.slice(0,8);
  renderPrayer();
});

// ---------- Quiz UI ----------
const quizTag = document.getElementById("quizTag");
const quizQ = document.getElementById("quizQ");
const quizOptions = document.getElementById("quizOptions");
const quizFeedback = document.getElementById("quizFeedback");
const quizQWrap = document.getElementById("quizQWrap");

function renderQuiz(){
  const item = QUIZ_BANK[quiz.idx];
  quizTag.textContent = item.tag;
  document.getElementById("quizStreak").textContent = quiz.streak;
  quizQ.textContent = item.q;

  quizOptions.innerHTML="";
  item.options.forEach((opt, i)=>{
    const div=document.createElement("div");
    div.className="item quizopt";
    if(quiz.pick===i) div.classList.add("active");
    div.innerHTML = `<div class="t" style="font-weight:680">${opt}</div>`;
    div.addEventListener("click", ()=>{
      sfxClick();
      quiz.pick = i;
      renderQuiz();
    });
    quizOptions.appendChild(div);
  });

  quizFeedback.innerHTML="";
  if(quiz.feedback){
    const box=document.createElement("div");
    box.className = "feedback " + (quiz.feedback.ok ? "good":"bad");
    box.innerHTML = `
      <div class="top" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div class="t" style="font-size:13px">${quiz.feedback.ok ? "Correct" : "Not quite"}</div>
        <span class="badge">+${quiz.feedback.delta} XP</span>
      </div>
      <div class="s" style="margin-top:6px">${quiz.feedback.why || ""}</div>
    `;
    quizFeedback.appendChild(box);
  }
}
function nextQuiz(){
  sfxClick();
  quiz.idx = (quiz.idx + 1) % QUIZ_BANK.length;
  quiz.pick = null;
  quiz.feedback = null;
  renderQuiz();
}
document.getElementById("btnQuizSubmit").addEventListener("click", (e)=>{
  if(quiz.pick==null){
    sfxFail();
    quizQWrap.classList.add("shake");
    setTimeout(()=>quizQWrap.classList.remove("shake"), 380);
    return;
  }
  const item = QUIZ_BANK[quiz.idx];
  const ok = quiz.pick === item.answer;
  const delta = ok ? (18 + Math.min(quiz.streak,5)*2) : 6;

  addXp(delta, ok ? "good" : "bad", e.currentTarget);

  if(ok){
    sfxSuccess();
    burstAtEl(e.currentTarget, "good");
    quiz.streak += 1;
  }else{
    sfxFail();
    quiz.streak = 0;
  }
  quiz.feedback = {ok, why:item.why, delta};
  renderQuiz();
});
document.getElementById("btnQuizNext").addEventListener("click", nextQuiz);

// Quiz builder
document.getElementById("btnAddQuestion").addEventListener("click", (e)=>{
  sfxClick();
  const q = document.getElementById("qbQ").value.trim();
  const tag = document.getElementById("qbTag").value.trim() || "Custom";
  const a = document.getElementById("qbA").value.trim() || "Option A";
  const b = document.getElementById("qbB").value.trim() || "Option B";
  const c = document.getElementById("qbC").value.trim() || "Option C";
  const d = document.getElementById("qbD").value.trim() || "Option D";
  const ans = parseInt(document.getElementById("qbAns").value,10);
  const why = document.getElementById("qbWhy").value.trim();

  if(!q){
    sfxFail();
    document.getElementById("qbQ").classList.add("shake");
    setTimeout(()=>document.getElementById("qbQ").classList.remove("shake"), 380);
    return;
  }

  QUIZ_BANK.push({ q, options:[a,b,c,d], answer: ans, why: why || "", tag });
  addXp(10, "warn", e.currentTarget);

  // clear
  document.getElementById("qbQ").value="";
  document.getElementById("qbA").value="";
  document.getElementById("qbB").value="";
  document.getElementById("qbC").value="";
  document.getElementById("qbD").value="";
  document.getElementById("qbWhy").value="";
});

// ---------- Init ----------
function init(){
  renderXp();

  // hilal
  altRange.value = hilal.altDeg;
  elongRange.value = hilal.elongDeg;
  ageRange.value = hilal.ageHours;
  widthRange.value = hilal.widthArcMin;
  renderHilal();

  // qibla
  bearingRange.value = 0;
  renderQibla();

  // prayer
  renderMethodSelect();
  renderPrayer();

  // quiz
  renderQuiz();

  // global click SFX on buttons/tabs (already on key actions, but this adds extra polish)
  document.querySelectorAll("button.btn").forEach(b=>{
    b.addEventListener("pointerdown", ()=>{ if(soundOn) sfxClick(); }, {passive:true});
  });
}
init();

// ---------- Random Hilal (button already wired above) ----------
document.getElementById("btnRandomHilal").addEventListener("click", ()=>{
  hilal.altDeg = round1(0.5 + rng()*6.0);
  hilal.elongDeg = round1(4.0 + rng()*8.0);
  hilal.ageHours = Math.round(8 + rng()*18);
  hilal.widthArcMin = round2(0.04 + rng()*0.26);
  hilal.haze = rng() < 0.35;
  hilal.clouds = rng() < 0.25;

  altRange.value = hilal.altDeg;
  elongRange.value = hilal.elongDeg;
  ageRange.value = hilal.ageHours;
  widthRange.value = hilal.widthArcMin;
  renderHilal();
});
</script>
</body>
</html>
